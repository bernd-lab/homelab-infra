---
# Kubernetes Worker-Installation

- name: Erstelle keyrings-Verzeichnis
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Lade und importiere Kubernetes GPG-Key
  shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.34/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Füge Kubernetes-Repository hinzu
  apt_repository:
    repo: 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /'
    state: present
    filename: kubernetes

- name: Aktualisiere Paket-Liste
  apt:
    update_cache: yes

- name: Installiere Kubernetes-Tools
  apt:
    name:
      - kubelet={{ kubernetes_package_version }}
      - kubeadm={{ kubernetes_package_version }}
      - kubectl={{ kubernetes_package_version }}
    state: present

- name: Halte Kubernetes-Pakete zurück
  command: apt-mark hold kubelet kubeadm kubectl
  changed_when: false

- name: Extrahiere Join-Command vom Master
  shell: |
    kubeadm token create --print-join-command
  delegate_to: homelab
  environment:
    KUBECONFIG: /home/bernd/.kube/config
  register: join_command
  changed_when: false
  failed_when: false

- name: Führe kubeadm join aus
  shell: "{{ join_command.stdout }}"
  register: kubeadm_join
  changed_when: "'This node has joined the cluster' in kubeadm_join.stdout"
  failed_when: "'error' in kubeadm_join.stderr and 'already a member' not in kubeadm_join.stderr"

